name: üöÄ Deploy Microservices

on:
  push:
    branches: [main, prod]
    paths:
      - 'Backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        default: production
        options:
          - production
          - staging

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APPS_ENVIRONMENT: ${{ secrets.CONTAINER_APPS_ENVIRONMENT || 'managedEnvironment-rgblob-bb4b' }}
  PNPM_VERSION: 8

jobs:
  # =================================================================================================
  # üê≥ BUILD JOB - Fast, Cached, Unified
  # =================================================================================================
  build:
    name: üê≥ Build & Push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile.unified
          push: true
          build-args: PNPM_VERSION=${{ env.PNPM_VERSION }}
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =================================================================================================
  # üöÄ DEPLOY JOBS - Parallel Execution for Speed
  # =================================================================================================
  deploy-gateway:
    name: üöÄ Gateway
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Gateway
        run: |
          az containerapp create \
            --name shikshak-backend \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 4000 \
            --ingress external \
            --min-replicas 0 --max-replicas 10 \
            --command "node" --args "/app/ApiGateway/index.js" \
            --env-vars \
              NODE_ENV=production \
              PORT_GATEWAY=4000 \
              CORS_ORIGIN=${{ secrets.FRONTEND_URL }} \
              AUTH_SERVICE_URL=http://shikshak-auth \
              COURSES_SERVICE_URL=http://shikshak-courses \
              PAYMENT_SERVICE_URL=http://shikshak-payment

  deploy-auth:
    name: üöÄ Auth
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Auth
        run: |
          az containerapp create \
            --name shikshak-auth \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 3000 \
            --ingress internal \
            --min-replicas 0 --max-replicas 10 \
            --command "node" --args "/app/Auth/dist/server.js" \
            --secrets "mongo-uri=${{ secrets.MONGO_URI }}" "better-auth-secret=${{ secrets.BETTER_AUTH_SECRET }}" \
            --env-vars \
              NODE_ENV=production \
              PORT=3000 \
              NEXT_PUBLIC_API_GATEWAY_URL=${{ secrets.NEXT_PUBLIC_API_GATEWAY_URL }} \
              GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
              GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} \
              MONGO_URI=secretref:mongo-uri \
              BETTER_AUTH_SECRET=secretref:better-auth-secret

  deploy-courses:
    name: üöÄ Courses
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Need checkout for KEDA yaml
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Courses
        run: |
          az containerapp create \
            --name shikshak-courses \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 4002 \
            --ingress internal \
            --min-replicas 0 --max-replicas 10 \
            --scale-rule-name azure-eventhub-rule \
            --scale-rule-type azure-eventhub \
            --scale-rule-metadata "consumerGroup=\$Default" "unprocessedEventThreshold=1" "blobContainer=eventhub-checkpoints" "eventHubName=course" \
            --scale-rule-auth "connection=eventhub-connection-string" "storageConnection=azure-storage-connection-string" \
            --command "node" --args "/app/Courses/index.js" \
            --secrets "mongo-uri=${{ secrets.MONGO_URI }}" "eventhub-connection-string=${{ secrets.EVENTHUB_CONNECTION_STRING }}" "azure-storage-connection-string=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --env-vars \
              NODE_ENV=production \
              PORT_COURSES=4002 \
              RAG_SERVICE_URL=${{ secrets.RAG_SERVICE_URL }} \
              AZURE_STORAGE_CONNECTION_STRING=secretref:azure-storage-connection-string \
              EVENTHUB_CONNECTION_STRING=secretref:eventhub-connection-string \
              REDIS_URL=${{ secrets.REDIS_URL }} \
              MONGO_URI=secretref:mongo-uri

  deploy-payment:
    name: üöÄ Payment
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Payment
        run: |
          az containerapp create \
            --name shikshak-payment \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 4003 \
            --ingress internal \
            --min-replicas 0 --max-replicas 10 \
            --command "node" --args "/app/payment/index.js" \
            --secrets "mongo-uri=${{ secrets.MONGO_URI }}" \
            --env-vars \
              NODE_ENV=production \
              PORT=4003 \
              RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }} \
              RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }} \
              MONGO_URI=secretref:mongo-uri

  # =================================================================================================
  # üßπ CLEANUP JOB - Cost Optimization
  # =================================================================================================
  cleanup:
    name: üßπ Cleanup Old Images
    needs: [deploy-gateway, deploy-auth, deploy-courses, deploy-payment]
    runs-on: ubuntu-latest
    if: always() # Run even if one deployment fails, to keep registry clean
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Purge Old Images
        run: |
          # Keep only the last 5 images to save storage costs
          az acr run --registry ${{ secrets.ACR_LOGIN_SERVER }} \
            --cmd "acr purge --filter 'shikshak-backend:.*' --ago 7d --keep 5 --untagged" /dev/null
        continue-on-error: true
