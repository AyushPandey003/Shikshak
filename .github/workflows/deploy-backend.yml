name: üöÄ Deploy Microservices

on:
  push:
    branches: [main, prod]
    paths:
      - 'Backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        default: production
        options:
          - production
          - staging

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APPS_ENVIRONMENT: ${{ secrets.CONTAINER_APPS_ENVIRONMENT || 'managedEnvironment-rgblob-bb4b' }}
  PNPM_VERSION: 8

jobs:
  build:
    name: üê≥ Build & Push Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile.unified
          push: true
          build-args: PNPM_VERSION=${{ env.PNPM_VERSION }}
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: üöÄ Deploy Services
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # GATEWAY
      - name: Deploy Gateway (shikshak-backend)
        run: |
          az containerapp create \
            --name shikshak-backend \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 4000 \
            --ingress external \
            --min-replicas 0 --max-replicas 10 \
            --command "node" \
            --args "index.js" \
            --env-vars \
              NODE_ENV=production \
              PORT_GATEWAY=4000 \
              CORS_ORIGIN=${{ secrets.FRONTEND_URL }} \
              AUTH_SERVICE_URL=http://shikshak-auth \
              COURSES_SERVICE_URL=http://shikshak-courses \
              PAYMENT_SERVICE_URL=http://shikshak-payment
        continue-on-error: false

      # AUTH
      - name: Deploy Auth (shikshak-auth)
        run: |
          az containerapp create \
            --name shikshak-auth \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 3000 \
            --ingress internal \
            --min-replicas 0 --max-replicas 10 \
            --command "node" \
            --args "dist/server.js" \
            --secrets "mongo-uri=${{ secrets.MONGO_URI }}" "better-auth-secret=${{ secrets.BETTER_AUTH_SECRET }}" \
            --env-vars \
              NODE_ENV=production \
              PORT=3000 \
              NEXT_PUBLIC_API_GATEWAY_URL=${{ secrets.NEXT_PUBLIC_API_GATEWAY_URL }} \
              GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
              GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} \
              MONGO_URI=secretref:mongo-uri \
              BETTER_AUTH_SECRET=secretref:better-auth-secret

      # COURSES
      - name: Deploy Courses (shikshak-courses)
        run: |
          az containerapp create \
            --name shikshak-courses \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 4002 \
            --ingress internal \
            --min-replicas 0 --max-replicas 10 \
            --yaml-config-path ./Backend/Courses/keda.yaml \
            --command "node" \
            --args "index.js" \
            --secrets "mongo-uri=${{ secrets.MONGO_URI }}" \
            --env-vars \
              NODE_ENV=production \
              PORT_COURSES=4002 \
              RAG_SERVICE_URL=${{ secrets.RAG_SERVICE_URL }} \
              AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }} \
              EVENTHUB_CONNECTION_STRING=${{ secrets.EVENTHUB_CONNECTION_STRING }} \
              REDIS_URL=${{ secrets.REDIS_URL }} \
              MONGO_URI=secretref:mongo-uri

      # PAYMENT
      - name: Deploy Payment (shikshak-payment)
        run: |
          az containerapp create \
            --name shikshak-payment \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }} \
            --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 4003 \
            --ingress internal \
            --min-replicas 0 --max-replicas 10 \
            --command "node" \
            --args "index.js" \
            --secrets "mongo-uri=${{ secrets.MONGO_URI }}" \
            --env-vars \
              NODE_ENV=production \
              PORT=4003 \
              RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }} \
              RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }} \
              MONGO_URI=secretref:mongo-uri
