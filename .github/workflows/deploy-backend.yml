name: üöÄ Deploy Microservices

on:
  push:
    branches: [main, prod]
    paths:
      - 'Backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        default: production
        options:
          - production
          - staging

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APPS_ENVIRONMENT: ${{ secrets.CONTAINER_APPS_ENVIRONMENT || 'managedEnvironment-rgblob-bb4b' }}
  PNPM_VERSION: 8

jobs:
  build:
    name: üê≥ Build & Push Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile.unified
          push: true
          build-args: PNPM_VERSION=${{ env.PNPM_VERSION }}
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-gateway:
    name: üöÄ Deploy Gateway
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy shikshak-gateway
        uses: azure/container-apps-deploy-action@v1
        with:
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
          containerAppName: shikshak-backend
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.CONTAINER_APPS_ENVIRONMENT }}
          targetPort: 4000
          ingress: external
          # Override CMD to run only Gateway
          containerCommand: node index.js
          workDir: /app/ApiGateway
          minReplicas: 0
          maxReplicas: 10
          environmentVariables: |
            NODE_ENV=production
            PORT_GATEWAY=4000
            CORS_ORIGIN=${{ secrets.FRONTEND_URL }}
            AUTH_SERVICE_URL=http://shikshak-auth
            COURSES_SERVICE_URL=http://shikshak-courses
            PAYMENT_SERVICE_URL=http://shikshak-payment

  deploy-auth:
    name: üöÄ Deploy Auth
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy shikshak-auth
        uses: azure/container-apps-deploy-action@v1
        with:
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
          containerAppName: shikshak-auth
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.CONTAINER_APPS_ENVIRONMENT }}
          targetPort: 3000
          ingress: internal
          containerCommand: node dist/server.js
          workDir: /app/Auth
          minReplicas: 0
          maxReplicas: 10
          environmentVariables: |
            NODE_ENV=production
            PORT=3000
            NEXT_PUBLIC_API_GATEWAY_URL=${{ secrets.NEXT_PUBLIC_API_GATEWAY_URL }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            MONGO_URI=secretref:mongo-uri
            BETTER_AUTH_SECRET=secretref:better-auth-secret
          secrets: |
            mongo-uri=${{ secrets.MONGO_URI }}
            better-auth-secret=${{ secrets.BETTER_AUTH_SECRET }}

  deploy-courses:
    name: üöÄ Deploy Courses
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy shikshak-courses
        uses: azure/container-apps-deploy-action@v1
        with:
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
          containerAppName: shikshak-courses
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.CONTAINER_APPS_ENVIRONMENT }}
          targetPort: 4002
          ingress: internal
          containerCommand: node index.js
          workDir: /app/Courses
          minReplicas: 0
          maxReplicas: 10
          environmentVariables: |
            NODE_ENV=production
            PORT_COURSES=4002
            RAG_SERVICE_URL=${{ secrets.RAG_SERVICE_URL }}
            AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
            EVENTHUB_CONNECTION_STRING=${{ secrets.EVENTHUB_CONNECTION_STRING }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            MONGO_URI=secretref:mongo-uri
          secrets: |
            mongo-uri=${{ secrets.MONGO_URI }}

  deploy-payment:
    name: üöÄ Deploy Payment
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy shikshak-payment
        uses: azure/container-apps-deploy-action@v1
        with:
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
          containerAppName: shikshak-payment
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.CONTAINER_APPS_ENVIRONMENT }}
          targetPort: 4003
          ingress: internal
          containerCommand: node index.js
          workDir: /app/payment
          minReplicas: 0
          maxReplicas: 10
          environmentVariables: |
            NODE_ENV=production
            PORT=4003
            RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
            RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
            MONGO_URI=secretref:mongo-uri
          secrets: |
            mongo-uri=${{ secrets.MONGO_URI }}
