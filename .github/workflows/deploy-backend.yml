name: üöÄ Deploy Microservices

on:
  push:
    branches: [main, prod]
    paths:
      - 'Backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        default: production
        options:
          - production
          - staging

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APPS_ENVIRONMENT: ${{ secrets.CONTAINER_APPS_ENVIRONMENT || 'managedEnvironment-rgblob-bb4b' }}
  PNPM_VERSION: 8

jobs:
  # =================================================================================================
  # üê≥ BUILD JOB - Fast, Cached, Unified
  # =================================================================================================
  build:
    name: üê≥ Build & Push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile.unified
          push: true
          build-args: PNPM_VERSION=${{ env.PNPM_VERSION }}
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =================================================================================================
  # üöÄ DEPLOY JOBS - Update images only (preserves Terraform-managed config)
  # =================================================================================================
  deploy-gateway:
    name: üöÄ Gateway
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Gateway
        run: |
          az containerapp update \
            --name shikshak-backend \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}

  deploy-auth:
    name: üöÄ Auth
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Auth
        run: |
          az containerapp update \
            --name shikshak-auth \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}

  deploy-courses:
    name: üöÄ Courses
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Courses
        run: |
          az containerapp update \
            --name shikshak-courses \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}

  deploy-payment:
    name: üöÄ Payment
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Payment
        run: |
          az containerapp update \
            --name shikshak-payment \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/shikshak-backend:${{ github.sha }}

  # =================================================================================================
  # üßπ CLEANUP JOB - Cost Optimization
  # =================================================================================================
  cleanup:
    name: üßπ Cleanup Old Images
    needs: [deploy-gateway, deploy-auth, deploy-courses, deploy-payment]
    runs-on: ubuntu-latest
    if: always() # Run even if one deployment fails, to keep registry clean
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Purge Old Images
        run: |
          # Keep only the last 5 images to save storage costs
          az acr run --registry ${{ secrets.ACR_LOGIN_SERVER }} \
            --cmd "acr purge --filter 'shikshak-backend:.*' --ago 7d --keep 5 --untagged" /dev/null
        continue-on-error: true
